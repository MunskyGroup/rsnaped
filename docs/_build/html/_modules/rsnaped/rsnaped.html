

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>rsnaped.rsnaped &mdash; rsnaped 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> rsnaped
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">rsnaped</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>rsnaped.rsnaped</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for rsnaped.rsnaped</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">**********</span>
<span class="sd">rSNAPed </span>
<span class="sd">**********</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">A software for single-molecule image tracking, simulation and parameter estimation.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="c1"># https://eikonomega.medium.com/getting-started-with-sphinx-autodoc-part-1-2cebbbca5365</span>


<span class="c1">#module_name, package_name, ClassName, method_name, </span>
<span class="c1"># ExceptionName, function_name, GLOBAL_CONSTANT_NAME, </span>
<span class="c1"># global_var_name, instance_var_name, function_parameter_name, local_var_name.</span>

<span class="c1"># Conventions.</span>
<span class="c1">#number_timepoints</span>
<span class="c1"># number_channels</span>
<span class="c1"># index_channels</span>
<span class="c1"># index_time</span>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">**********</span>
<span class="sd">Libraries</span>
<span class="sd">**********</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1"># System libraries</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1">#import statistics</span>
<span class="kn">from</span> <span class="nn">statistics</span> <span class="kn">import</span> <span class="n">median_low</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">nan</span>
<span class="c1"># To manipulate arrays</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>  
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">unravel_index</span>
<span class="c1"># For data frames</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>   
<span class="c1"># Ignoring warnings</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="c1"># Skimage</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">img_as_float64</span><span class="p">,</span> <span class="n">img_as_uint</span>
<span class="kn">from</span> <span class="nn">skimage.filters.rank</span> <span class="kn">import</span> <span class="n">entropy</span>
<span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="kn">import</span> <span class="n">disk</span>
<span class="kn">from</span> <span class="nn">skimage.filters</span> <span class="kn">import</span> <span class="n">threshold_minimum</span>
<span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="kn">import</span> <span class="n">binary_closing</span>
<span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">find_contours</span>
<span class="kn">from</span> <span class="nn">skimage.draw</span> <span class="kn">import</span> <span class="n">polygon2mask</span>
<span class="kn">from</span> <span class="nn">skimage.draw</span> <span class="kn">import</span> <span class="n">polygon</span>
<span class="kn">from</span> <span class="nn">skimage.util</span> <span class="kn">import</span> <span class="n">random_noise</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">warp</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">transform</span>
<span class="kn">from</span> <span class="nn">skimage.filters</span> <span class="kn">import</span> <span class="n">difference_of_gaussians</span>
<span class="kn">from</span> <span class="nn">skimage.filters</span> <span class="kn">import</span> <span class="n">gaussian</span>
<span class="kn">from</span> <span class="nn">skimage.draw</span> <span class="kn">import</span> <span class="n">polygon_perimeter</span>
<span class="c1"># Open cv</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="c1"># Parallel computing</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="c1"># Particle tracking</span>
<span class="kn">import</span> <span class="nn">trackpy</span> <span class="k">as</span> <span class="nn">tp</span> 
<span class="n">tp</span><span class="o">.</span><span class="n">quiet</span><span class="p">()</span>  <span class="c1"># Turn off progress reports for best performance</span>
<span class="c1"># To create interactive elements</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span> 
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interactive</span><span class="p">,</span> <span class="n">HBox</span><span class="p">,</span> <span class="n">Layout</span><span class="p">,</span> <span class="n">GridspecLayout</span> <span class="c1">#, interact, fixed, interact_manual, Button, VBox</span>
<span class="kn">import</span> <span class="nn">bqplot</span> <span class="k">as</span> <span class="nn">bq</span>
<span class="kn">from</span> <span class="nn">bqplot</span> <span class="kn">import</span> <span class="n">LinearScale</span><span class="p">,</span> <span class="n">ColorScale</span><span class="p">,</span> <span class="n">HeatMap</span>
<span class="c1"># Scipy </span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">sps</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">find_peaks</span> <span class="c1">#, peak_prominences, find_peaks_cwt</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">Delaunay</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>
<span class="c1"># To read .tiff files</span>
<span class="kn">import</span> <span class="nn">tifffile</span>
<span class="c1"># to create gifs</span>
<span class="kn">import</span> <span class="nn">imageio</span>
<span class="c1"># time libraries</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="c1"># Cellpose</span>
<span class="kn">from</span> <span class="nn">cellpose</span> <span class="kn">import</span> <span class="n">models</span> 
<span class="c1"># Plotting</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span> 
<span class="kn">import</span> <span class="nn">matplotlib.path</span> <span class="k">as</span> <span class="nn">mpltPath</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">gridspec</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;dark_background&quot;</span><span class="p">)</span>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">**********</span>
<span class="sd">Clases</span>
<span class="sd">**********</span>
<span class="sd">&#39;&#39;&#39;</span>


<div class="viewcode-block" id="ConverToStandardFormat"><a class="viewcode-back" href="../../index.html#rsnaped.rsnaped.ConverToStandardFormat">[docs]</a><span class="k">class</span> <span class="nc">ConverToStandardFormat</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class contains two methods to:</span>
<span class="sd">    </span>
<span class="sd">    1. Transform any numpy array of images into the format [T,Y,X,C]. </span>
<span class="sd">    2. Convert an image into an array video with a single time point (this last is necessary for compatibility).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    video : numpy array </span>
<span class="sd">        Array of images. This class accepts arrays with formats: [Y,X], [T,Y,X], [T,Y,X,C], or anyother permutation of channels, the user must specify the position of each dimension in the original video by deffining the parameters: time_position,height_position,width_position,channel_position.</span>
<span class="sd">    time_position : int, optional</span>
<span class="sd">        Position for the dimension for the time in the original video array. The default is 0.</span>
<span class="sd">    height_position : int, optional</span>
<span class="sd">        Position for the dimension for the y-axis (height) in the original video array. The default is 1.</span>
<span class="sd">    width_position : int, optional</span>
<span class="sd">        Position for the dimension for the x-axis (width) in the original video array. The default is 2.</span>
<span class="sd">    channel_position : int, optional</span>
<span class="sd">        Position for the dimension for the channels in the original video array. The default is 3.</span>
<span class="sd">    &#39;&#39;&#39;</span>    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">time_position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">height_position</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="n">width_position</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">channel_position</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video</span> <span class="o">=</span> <span class="n">video</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_dimension</span> <span class="o">=</span> <span class="n">time_position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height_dimension</span> <span class="o">=</span> <span class="n">height_position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width_dimension</span> <span class="o">=</span> <span class="n">width_position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_dimension</span> <span class="o">=</span> <span class="n">channel_position</span>
<div class="viewcode-block" id="ConverToStandardFormat.transpose_video"><a class="viewcode-back" href="../../index.html#rsnaped.rsnaped.ConverToStandardFormat.transpose_video">[docs]</a>    <span class="k">def</span> <span class="nf">transpose_video</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Method that transposes an unsorted video to the standard [T,Y,X,C]</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        video_correct_order : np.uint16</span>
<span class="sd">            Array with dimensions [T,Y,X,C].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># making a copy of the video</span>
        <span class="n">video_transposed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
        <span class="c1"># reshaping the video</span>
        <span class="n">video_transposed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">video_transposed</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_dimension</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height_dimension</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width_dimension</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_dimension</span><span class="p">))</span>
        <span class="c1"># calculating the video shape</span>
        <span class="n">number_frames</span> <span class="o">=</span> <span class="n">video_transposed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">video_transposed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">video_transposed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">number_channels</span> <span class="o">=</span> <span class="n">video_transposed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="c1"># Filling  with zeros the dimension with channel in case it has less than 3 colors video.</span>
        <span class="k">if</span> <span class="n">video_transposed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;The video has been transposed to the format [T,Y,X,C] and the channels are RGB&#39;</span><span class="p">)</span>
            <span class="n">video_correct_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_frames</span><span class="p">,</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
            <span class="n">video_correct_order</span><span class="p">[:,:,:,:</span><span class="n">number_channels</span><span class="p">]</span> <span class="o">=</span> <span class="n">video_transposed</span>
        <span class="k">elif</span> <span class="n">video_transposed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;The video has been transposed to the format [T,Y,X,C]&#39;</span><span class="p">)</span>
            <span class="n">video_correct_order</span> <span class="o">=</span> <span class="n">video_transposed</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">video_correct_order</span></div>
    
<div class="viewcode-block" id="ConverToStandardFormat.image_to_video"><a class="viewcode-back" href="../../index.html#rsnaped.rsnaped.ConverToStandardFormat.image_to_video">[docs]</a>    <span class="k">def</span> <span class="nf">image_to_video</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Method that converts an image into a video with one frame. This process is done for compatibility with the rest of the classes.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        video_correct_order : np.uint16</span>
<span class="sd">            Array with dimensions [T,Y,X,C].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># This section corrects the video to the dimensions. [T,Y,X,C] in case it is an image with 2D x,y.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">video_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">video_correct_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
            <span class="n">video_correct_order</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">video_temp</span> 
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;The video has been converted to the format [T,Y,X,C] from [Y,X]&#39;</span><span class="p">)</span>  
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">video_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">video_correct_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
            <span class="n">video_correct_order</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:,:]</span> <span class="o">=</span> <span class="n">video_temp</span> 
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;The video has been converted to the format [T,Y,X,C] from [Y,X,C]&#39;</span><span class="p">)</span>  
        <span class="k">return</span> <span class="n">video_correct_order</span></div></div>
    
        
<div class="viewcode-block" id="RemoveExtrema"><a class="viewcode-back" href="../../index.html#rsnaped.rsnaped.RemoveExtrema">[docs]</a><span class="k">class</span> <span class="nc">RemoveExtrema</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class is inteded to remove extreme values from a video. The format of the video must be [T,Y,X,C].</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    video : numpy array </span>
<span class="sd">        Array of images with dimensions [T,Y,X,C].</span>
<span class="sd">    min_percentile : int, optional</span>
<span class="sd">        Lower bound to normalize intensity. The default is 1.</span>
<span class="sd">    max_percentile : TYPE, optional</span>
<span class="sd">        Higher bound to normalize intensity. The default is 99.</span>
<span class="sd">    ignore_channel : int or None, optional</span>
<span class="sd">        Use this option to ignore the normalization of a given channel. The default is None.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">min_percentile</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_percentile</span><span class="o">=</span><span class="mi">99</span><span class="p">,</span><span class="n">ignore_channel</span> <span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video</span> <span class="o">=</span> <span class="n">video</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_percentile</span> <span class="o">=</span> <span class="n">min_percentile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_percentile</span> <span class="o">=</span> <span class="n">max_percentile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_channel</span> <span class="o">=</span><span class="n">ignore_channel</span>
        
<div class="viewcode-block" id="RemoveExtrema.remove_outliers"><a class="viewcode-back" href="../../index.html#rsnaped.rsnaped.RemoveExtrema.remove_outliers">[docs]</a>    <span class="k">def</span> <span class="nf">remove_outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This method normalizes the values of a video by removing extreme values.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        normalized_video : np.uint16</span>
<span class="sd">            Normalized video. Array with dimensions [T,Y,X,C].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">normalized_video</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
        <span class="n">number_timepoints</span><span class="p">,</span> <span class="n">number_channels</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index_channels</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">number_channels</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_channel</span> <span class="o">==</span><span class="n">index_channels</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">index_time</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">number_timepoints</span><span class="p">):</span>
                    <span class="n">normalized_video_temp</span> <span class="o">=</span> <span class="n">normalized_video</span><span class="p">[</span><span class="n">index_time</span><span class="p">,:,:,</span><span class="n">index_channels</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">normalized_video_temp</span><span class="p">)</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># this section detect that the channel is not empty to perform the normalization.</span>
                        <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">normalized_video_temp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_percentile</span><span class="p">)</span>
                        <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">normalized_video_temp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_percentile</span><span class="p">)</span>
                        <span class="n">normalized_video_temp</span> <span class="p">[</span><span class="n">normalized_video_temp</span><span class="o">&gt;</span> <span class="n">max_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_val</span>
                        <span class="n">normalized_video_temp</span> <span class="p">[</span><span class="n">normalized_video_temp</span><span class="o">&lt;</span> <span class="n">min_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_val</span>
                        <span class="n">normalized_video_temp</span> <span class="p">[</span><span class="n">normalized_video_temp</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">return</span> <span class="n">normalized_video</span></div></div>


<div class="viewcode-block" id="ScaleVideo"><a class="viewcode-back" href="../../index.html#rsnaped.rsnaped.ScaleVideo">[docs]</a><span class="k">class</span> <span class="nc">ScaleVideo</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class is intended to scale the intensity values in a video. The format of the video must be [T,Y,X,C].</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    video : numpy array </span>
<span class="sd">        Array of images with dimensions [T,Y,X,C].</span>
<span class="sd">    scale_percentage : float, optional</span>
<span class="sd">        Percentage value (between 0 and 1, where 0.5 represents 50% scaling) to scale the video. The default is 1.</span>
<span class="sd">    ignore_channel : int or None, optional</span>
<span class="sd">        Use this option to ignore the normalization of a given channel. The default is None.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">scale_percentage</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ignore_channel</span> <span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video</span> <span class="o">=</span> <span class="n">video</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_percentage</span> <span class="o">=</span> <span class="n">scale_percentage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_channel</span> <span class="o">=</span> <span class="n">ignore_channel</span>
<div class="viewcode-block" id="ScaleVideo.apply_scale"><a class="viewcode-back" href="../../index.html#rsnaped.rsnaped.ScaleVideo.apply_scale">[docs]</a>    <span class="k">def</span> <span class="nf">apply_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This method is intendent to scale the intensity values of a video.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        scaled_video : np.uint16</span>
<span class="sd">            Scaled video. Array with dimensions [T,Y,X,C].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">scaled_video</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
        <span class="n">number_timepoints</span><span class="p">,</span> <span class="n">number_channels</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index_channels</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">number_channels</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_channel</span> <span class="o">==</span><span class="n">index_channels</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">index_time</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">number_timepoints</span><span class="p">):</span>
                    <span class="n">scaled_video_temp</span> <span class="o">=</span> <span class="n">scaled_video</span><span class="p">[</span><span class="n">index_time</span><span class="p">,:,:,</span><span class="n">index_channels</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">scaled_video_temp</span><span class="p">)</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># this section detect that the channel is not empty to perform the normalization.</span>
                        <span class="n">scaled_video_temp</span> <span class="o">=</span> <span class="n">scaled_video_temp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_percentage</span>
                        <span class="n">scaled_video_temp</span><span class="p">[</span><span class="n">scaled_video_temp</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">return</span> <span class="n">scaled_video</span></div></div>
    
    
<div class="viewcode-block" id="BandpassFilter"><a class="viewcode-back" href="../../index.html#rsnaped.rsnaped.BandpassFilter">[docs]</a><span class="k">class</span> <span class="nc">BandpassFilter</span><span class="p">():</span> 
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class is intended to apply high and low bandpass filters to the video. The format of the video must be [T,Y,X,C].</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    video : numpy array </span>
<span class="sd">        array of images.</span>
<span class="sd">    min_percentile : int, optional</span>
<span class="sd">        Lower bound to normalize intensity. The default is 1.</span>
<span class="sd">    max_percentile : TYPE, optional</span>
<span class="sd">        Higher bound to normalize intensity. The default is 99.</span>
<span class="sd">    ignore_channel : int or None, optional</span>
<span class="sd">        Use this option to ignore the normalization of a given channel. The default is None.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">video</span><span class="p">,</span> <span class="n">low_pass</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">high_pass</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="c1"># Making the values for the filters are odd numbers</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">low_pass</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">low_pass</span> <span class="o">=</span> <span class="n">low_pass</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">high_pass</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">high_pass</span> <span class="o">=</span> <span class="n">high_pass</span><span class="o">+</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video</span> <span class="o">=</span> <span class="n">video</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low_pass</span> <span class="o">=</span> <span class="n">low_pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">high_pass</span> <span class="o">=</span> <span class="n">high_pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUMBER_OF_CORES</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
                 
<div class="viewcode-block" id="BandpassFilter.apply_filter"><a class="viewcode-back" href="../../index.html#rsnaped.rsnaped.BandpassFilter.apply_filter">[docs]</a>    <span class="k">def</span> <span class="nf">apply_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This method applies high and low bandpass filters to the video. The method uses **difference_of_gaussians** from skimage.filters.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        video_filtered : np.uint16</span>
<span class="sd">            Filtered video resulting from the bandpass process. Array with format [T,Y,X,C].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">video_bp_filtered_float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> 
        <span class="n">number_timepoints</span><span class="p">,</span> <span class="n">number_channels</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  
        <span class="k">for</span> <span class="n">index_channels</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">number_channels</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">index_time</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">number_timepoints</span><span class="p">):</span>
                <span class="n">video_bp_filtered_float</span><span class="p">[</span><span class="n">index_time</span><span class="p">,:,:,</span><span class="n">index_channels</span><span class="p">]</span><span class="o">=</span> <span class="n">difference_of_gaussians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="p">[</span><span class="n">index_time</span><span class="p">,:,:,</span><span class="n">index_channels</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_pass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_pass</span><span class="p">)</span>
        
        <span class="c1"># temporal function that converts floats to uint</span>
        <span class="k">def</span> <span class="nf">img_uint</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
            <span class="n">temp_vid</span><span class="o">=</span> <span class="n">img_as_uint</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">temp_vid</span>
        <span class="c1"># returning the image normalized as uint. Notice that difference_of_gaussians converts the image into float.</span>
        <span class="k">for</span> <span class="n">index_channels</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">number_channels</span><span class="p">):</span>
            <span class="n">init_video</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBER_OF_CORES</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">img_uint</span><span class="p">)(</span><span class="n">video_bp_filtered_float</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="n">index_channels</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">number_timepoints</span><span class="p">))</span> 
            <span class="n">video_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">init_video</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">video_filtered</span>    </div></div>









































    
    
    
    
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Luis Aguilera.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>